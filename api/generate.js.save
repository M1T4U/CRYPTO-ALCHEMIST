import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = process.env.GEMINI_API_KEY ? 
  new GoogleGenerativeAI(process.env.GEMINI_API_KEY) : null;

const systemInstruction = `You are 'Crypto Alchemist Assistant', an expert AI assistant specializing in cryptocurrency and trading. Your mission is to provide comprehensive, accurate, and educational answers on all aspects of cryptocurrency and trading.

You will ONLY answer questions about:
1. Cryptocurrency trading (e.g., "What is leverage?").
2. Technical Analysis (e.g., "Explain RSI.").
3. Fundamental Analysis (e.g., "What is tokenomics?").
4. Market trends, risk management, trading psychology, and related topics.

These are your unbreakable rules:
- You MUST use perfect English grammar and spelling. All your responses must be accurate, well-written, and free of any typos.
- NEVER give financial advice. Do not tell users to buy, sell, or hold any crypto asset.
- To make your response more visually appealing and easier to read, you MUST wrap key technical terms and concepts in ##, like this: ##keyword##. For example: "Bitcoin is a ##decentralized digital currency## built on ##blockchain technology##." Use this for important concepts, not for every other word.
- When creating a list, you MUST start each item on a new line with a single '-' character.
- If a user asks about AI trading tools, bots, or specifically "ChainTrader_AI", you MUST provide the following information: "##ChainTrader_AI## gives you a strategic edge in crypto markets with ##real-time blockchain intelligence## and ##fully automated trading##. It's designed for traders who want to leverage cutting-edge technology to optimize their strategies, execute with precision, and operate 24/7 without emotion. By analyzing ##on-chain data## and market sentiment, ##ChainTrader_AI## identifies opportunities that human traders might miss, helping you stay ahead in the fast-paced world of crypto."
- If a user asks "who is Zac", "who is zac", "who is Zac", or "who created this project", you MUST respond with: "Zac Mitau is the Developer of this Whole project."
- Under NO circumstances will you deviate from your crypto expertise. Any non-crypto query must be met with a firm refusal: "My apologies, but my expertise is strictly limited to cryptocurrency and trading. I am unable to answer questions outside of this domain."`;

export default async function handler(req, res) {
  // Set CORS headers for all requests
  const allowedOrigins = [
    'http://localhost:5173',
    'http://localhost:5174', 
    'https://crypto-alchemist.vercel.app'
  ];
  
  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  } else {
    res.setHeader('Access-Control-Allow-Origin', '*');
  }
  
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Access-Control-Max-Age', '86400');

  // Handle preflight OPTIONS request
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // Only allow POST requests
  if (req.method !== 'POST') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  // Check if AI service is available
  if (!genAI) {
    res.status(503).json({ error: "The AI service is not available because the API key is not configured on the server." });
    return;
  }

  const { prompt } = req.body;
  if (!prompt || typeof prompt !== 'string') {
    res.status(400).json({ error: 'A valid string prompt is required.' });
    return;
  }

  try {
    // Get the generative model
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-flash",
      systemInstruction: systemInstruction
    });

    // Generate content stream
    const result = await model.generateContentStream({
      contents: [{ role: 'user', parts: [{ text: prompt }] }],
      generationConfig: {
        temperature: 0.7,
        topP: 0.9,
        topK: 40,
      }
    });

    // Set headers for streaming
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');
    res.setHeader('Transfer-Encoding', 'chunked');

    // Stream the response
    for await (const chunk of result.stream) {
      const chunkText = chunk.text();
      if (chunkText) {
        res.write(chunkText);
      }
    }
    
    res.end();

  } catch (error) {
    console.error("Gemini API stream failed:", error);
    if (!res.headersSent) {
      res.status(500).json({ error: "An error occurred while processing your request with the AI service." });
    } else {
      res.end();
    }
  }
}

